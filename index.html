<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Dataset</title>
<style>
  :root{--bg:#0b0c10;--panel:#111319;--muted:#8b93a7;--text:#e9ecf1;--line:#1d2230;--accent:#4c8bf5;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.28)}
  @media (prefers-color-scheme: light){:root{--bg:#f7f8fb;--panel:#ffffff;--muted:#5a6275;--text:#10131a;--line:#e8ebf3;--shadow:0 10px 25px rgba(16,19,26,.08)}}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .header{display:flex;justify-content:space-between;align-items:center;padding:16px}
  .title{font-weight:700;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:6px 10px}
  .search input{all:unset;width:220px}
  button,select{border:1px solid var(--line);background:transparent;color:var(--text);border-radius:10px;padding:8px 12px;min-height:36px;cursor:pointer}
  .primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .toolbar{display:flex;justify-content:space-between;align-items:center;padding:6px 16px 10px;border-top:1px solid var(--line)}
  .table-wrap{overflow:auto;border-top:1px solid var(--line)}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:720px}
  thead th{position:sticky;top:0;background:var(--panel);font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);border-bottom:1px solid var(--line);padding:10px;text-align:left;cursor:pointer}
  tbody td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
  tbody tr:hover{background:rgba(76,139,245,.07)}
  a.link{color:var(--accent);text-decoration:none} a.link:hover{text-decoration:underline}
  .empty{padding:24px;color:var(--muted)}
  .hint{padding:10px 16px;border-top:1px solid var(--line);font-size:12px;color:var(--muted)}
  .pagination{display:flex;gap:8px;align-items:center;padding:12px 16px}
  .spacer{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div>
        <div class="title">Live Dataset</div>
        <div class="sub" id="meta">Loading…</div>
      </div>
      <div class="controls">
        <label class="search"><input id="q" placeholder="Search…"></label>
        <select id="pageSize"><option>10</option><option selected>25</option><option>50</option><option>100</option></select>
        <button id="exportCsv">Export CSV</button>
        <button id="refresh" class="primary">Refresh</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="sub">Sort: click column header</div>
      <div class="spacer"></div>
      <div class="sub">Auto-refresh: 60s</div>
    </div>

    <div class="table-wrap">
      <table id="grid"><thead></thead><tbody></tbody></table>
      <div id="empty" class="empty" style="display:none">No data.</div>
    </div>

    <div class="pagination">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <div class="spacer"></div>
      <div class="sub" id="pageInfo">—</div>
    </div>

    <div class="hint" id="hint"></div>
  </div>
</div>

<script>
/** CONFIG **/
const DATA_URL = './data.json';
const AUTO_REFRESH_MS = 60000;

/** STATE **/
let raw=[], filtered=[]; let page=1, pageSize=25, sortKey=null, sortDir=1;

/** HELPERS **/
const $ = s => document.querySelector(s);
const escapeHTML = s => String(s).replace(/[&<>'"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;' }[m]));
const isLink = v => /^https?:\/\//i.test(String(v||''));
const toCsv = rows => {
  if(!rows.length) return '';
  const cols = Object.keys(rows[0]);
  const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
  return [cols.join(','), ...rows.map(r=>cols.map(c=>esc(r[c])).join(','))].join('\n');
};

/** LOAD **/
async function load(){
  try{
    const r = await fetch(`${DATA_URL}?v=${Date.now()}`, { cache:'no-cache' });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const json = await r.json();
    console.info('RAW JSON keys:', json && typeof json==='object' ? Object.keys(json) : '(array or null)');

    // Accept shapes: [ ... ] | { data:[...] } | { result:{ news_articles:[...] } }
    let arr = [];
    if (Array.isArray(json)) arr = json;
    else if (json && Array.isArray(json.data)) arr = json.data;
    else if (json && json.result && Array.isArray(json.result.news_articles)) arr = json.result.news_articles;

    console.info('Detected array length:', Array.isArray(arr) ? arr.length : 'N/A');

    // Normalize
    raw = (arr || []).filter(Boolean).map(x => ({
      title: x.title ?? '',
      hyperlink: x.hyperlink ?? '',
      content: x.content ?? ''
    }));

    applyFilters(); render(); renderMeta();
    setHint(raw.length ? '' : 'Loaded 0 rows. Ensure your array has objects with title/hyperlink/content.');
  } catch(e){
    console.error('data.json error:', e);
    setHint('Could not load data.json. Check URL, branch, and JSON validity.');
    showEmpty();
  }
}

/** FILTER / SORT / PAGINATION **/
function applyFilters(){
  const q = ($('#q')?.value || '').toLowerCase();
  filtered = raw.filter(r => !q || Object.values(r).some(v => String(v??'').toLowerCase().includes(q)));
  if (sortKey){
    filtered.sort((a,b)=>{
      const av=a[sortKey], bv=b[sortKey];
      const an=Number(av), bn=Number(bv);
      if(!isNaN(an)&&!isNaN(bn)) return (an-bn)*sortDir;
      const ad=Date.parse(av), bd=Date.parse(bv);
      if(!isNaN(ad)&&!isNaN(bd)) return (ad-bd)*sortDir;
      return String(av??'').localeCompare(String(bv??'')) * sortDir;
    });
  }
}
function totalPages(){ return Math.max(1, Math.ceil(filtered.length/pageSize)); }
function clampPage(){ page = Math.min(page, totalPages()); if(page<1) page=1; }

/** RENDER **/
function render(){
  const grid=$('#grid'), thead=grid.querySelector('thead'), tbody=grid.querySelector('tbody');
  if(!filtered.length){ showEmpty(); return; }
  $('#empty').style.display='none';

  const cols = Object.keys(filtered[0]||{});
  thead.innerHTML = '<tr>' + cols.map(c=>`<th data-col="${c}">${c}${sortKey===c?(sortDir>0?' ▲':' ▼'):''}</th>`).join('') + '</tr>';
  thead.querySelectorAll('th').forEach(h => h.onclick=()=>{ sortKey=h.dataset.col; sortDir = (sortKey===h.dataset.col ? -sortDir : 1); applyFilters(); clampPage(); render(); });

  clampPage();
  const start=(page-1)*pageSize, slice=filtered.slice(start,start+pageSize);
  tbody.innerHTML = slice.map(r=>'<tr>'+cols.map(c=>{
    const v=r[c];
    if (c==='hyperlink' && isLink(v)) return `<td><a class="link" href="${v}" target="_blank" rel="noopener">Open</a></td>`;
    return `<td>${escapeHTML(v)}</td>`;
  }).join('')+'</tr>').join('');

  $('#pageInfo').textContent = `Page ${page} / ${totalPages()} • rows: ${filtered.length}`;
}
function renderMeta(){ const m=$('#meta'); if(m) m.textContent=`rows: ${raw.length} • updated: ${new Date().toLocaleString()}`; }
function showEmpty(){ $('#grid thead').innerHTML=''; $('#grid tbody').innerHTML=''; $('#empty').style.display='block'; }
function setHint(msg){ const el=$('#hint'); if(el) el.textContent = msg||''; }

/** EVENTS **/
$('#q').addEventListener('input', ()=>{ applyFilters(); page=1; render(); renderMeta(); });
$('#pageSize').addEventListener('change', e=>{ pageSize=+e.target.value; page=1; render(); });
$('#refresh').addEventListener('click', load);
$('#exportCsv').addEventListener('click', ()=>{ if(!filtered.length) return; const csv=toCsv(filtered); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='dataset.csv'; a.click(); });
$('#prev').addEventListener('click', ()=>{ if(page>1){ page--; render(); } });
$('#next').addEventListener('click', ()=>{ if(page<totalPages()){ page++; render(); } });

/** BOOT **/
load(); setInterval(load, AUTO_REFRESH_MS);
</script>
</body>
</html>
